
CREATE OR REPLACE TABLE STG.SHPS_TOTALES_SVC_LOGISTICS AS (
SELECT 
MES_HANDLING,
SHP_LG_FACILITY_ID,
SIT_SITE_ID,
COUNT(shp_shipment_id) AS Q_SHP
FROM STG.CG_32
WHERE 
STATUS_FACTURABLE='OK'
and PICKING_TYPE_AJUSTADO in ('XD','FBM')
and SHP_CARRIER_ID in ('Logistics','MercadoEnvios','Mercado Envios')
GROUP BY 1,2,3
);


CREATE OR REPLACE TABLE STG.AMORT_SVC_LOGISTICS AS (
SELECT
A2.TIPO_CARGA,
a1.MES_HANDLING,
a1.SHP_LG_FACILITY_ID,
a1.SIT_SITE_ID,
CAST(sum(IFNULL(a2.NUMERATOR*1.0000, 0)) AS NUMERIC) as AMORT_SVC
FROM STG.SHPS_TOTALES_SVC_LOGISTICS a1 
INNER JOIN `meli-bi-data`.SBOX_SHPCDG.STG_AMORTIZATION_SVC a2 ON CAST(a1.MES_HANDLING AS STRING)=CAST(a2.MES_HANDLING AS STRING) and a1.SIT_SITE_ID=a2.SIT_SITE_ID and a1.SHP_LG_FACILITY_ID=a2.SHP_LG_FACILITY_ID AND A2.TIPO_CARGA='CPS'
WHERE A2.METRIC_NAME='SVC'
AND A2.SHP_LG_FACILITY_ID NOT IN ('N/A')
GROUP BY 1,2,3,4

UNION ALL

SELECT
A2.TIPO_CARGA,
a1.MES_HANDLING,
a1.SHP_LG_FACILITY_ID,
a1.SIT_SITE_ID,
CAST(sum(IFNULL(a2.NUMERATOR*1.0000, 0))/sum(IFNULL(a1.Q_SHP*1.0000, 0)) AS NUMERIC) as AMORT_SVC
FROM STG.SHPS_TOTALES_SVC_LOGISTICS a1 
INNER JOIN `meli-bi-data`.SBOX_SHPCDG.STG_AMORTIZATION_SVC a2 ON CAST(a1.MES_HANDLING AS STRING)=CAST(a2.MES_HANDLING AS STRING) and a1.SIT_SITE_ID=a2.SIT_SITE_ID and a1.SHP_LG_FACILITY_ID=a2.SHP_LG_FACILITY_ID AND A2.TIPO_CARGA='COSTO_TOTAL'
WHERE A2.METRIC_NAME='SVC'
AND A2.SHP_LG_FACILITY_ID NOT IN ('N/A')
GROUP BY 1,2,3,4
);


CREATE OR REPLACE TABLE STG.AMORT_SVC_LOGISTICS_SHP AS (
SELECT
a1.shp_shipment_id,
COALESCE(a2.AMORT_SVC,a3.AMORT_SVC,0) AS AMORT_SVC_2
from 
STG.CG_32 a1 
LEFT JOIN STG.AMORT_SVC_LOGISTICS a2 ON a1.MES_HANDLING=a2.MES_HANDLING and a1.SIT_SITE_ID=a2.SIT_SITE_ID and a1.SHP_LG_FACILITY_ID=a2.SHP_LG_FACILITY_ID and a2.TIPO_CARGA='CPS'
LEFT JOIN STG.AMORT_SVC_LOGISTICS a3 ON a1.MES_HANDLING=a3.MES_HANDLING and a1.SIT_SITE_ID=a3.SIT_SITE_ID and a1.SHP_LG_FACILITY_ID=a3.SHP_LG_FACILITY_ID and a3.TIPO_CARGA='COSTO_TOTAL'
WHERE COALESCE(a2.AMORT_SVC,a3.AMORT_SVC,0) > 0
and STATUS_FACTURABLE='OK'
and PICKING_TYPE_AJUSTADO in ('XD','FBM')
and SHP_CARRIER_ID in ('Logistics','MercadoEnvios','Mercado Envios')
);


CREATE OR REPLACE TABLE STG.AMORT_SVC_LOGISTICS_SHP_2 AS (
SELECT
a1.shp_shipment_id,
COALESCE(a2.AMORT_SVC,a3.AMORT_SVC,0) AS AMORT_SVC_2
from 
STG.CG_32 a1 
LEFT JOIN STG.AMORT_SVC_LOGISTICS a2 ON  (CASE WHEN SUBSTR(CAST(a1.MES_HANDLING AS STRING), 5, 2) <> '01' THEN (a1.MES_HANDLING - 1) ELSE (a1.MES_HANDLING - 100 + 11) END)=a2.MES_HANDLING and a1.SIT_SITE_ID=a2.SIT_SITE_ID and a1.SHP_LG_FACILITY_ID=a2.SHP_LG_FACILITY_ID and a2.TIPO_CARGA='CPS'
LEFT JOIN STG.AMORT_SVC_LOGISTICS a3 ON  (CASE WHEN SUBSTR(CAST(a1.MES_HANDLING AS STRING), 5, 2) <> '01' THEN (a1.MES_HANDLING - 1) ELSE (a1.MES_HANDLING - 100 + 11) END)=a3.MES_HANDLING and a1.SIT_SITE_ID=a3.SIT_SITE_ID and a1.SHP_LG_FACILITY_ID=a3.SHP_LG_FACILITY_ID and a3.TIPO_CARGA='COSTO_TOTAL'
WHERE COALESCE(a2.AMORT_SVC,a3.AMORT_SVC,0) > 0
and STATUS_FACTURABLE='OK'
and PICKING_TYPE_AJUSTADO in ('XD','FBM')
and SHP_CARRIER_ID in ('Logistics','MercadoEnvios','Mercado Envios')
);


CREATE OR REPLACE TABLE STG.AMORT_SVC_LOGISTICS_SHP_3 AS (
SELECT
a1.shp_shipment_id,
COALESCE(a2.AMORT_SVC,a3.AMORT_SVC,0) AS AMORT_SVC_2
from 
STG.CG_32 a1 
LEFT JOIN STG.AMORT_SVC_LOGISTICS a2 ON  (CASE WHEN SUBSTR(CAST(a1.MES_HANDLING AS STRING), 5, 2) <> '01' THEN (a1.MES_HANDLING - 2) ELSE (a1.MES_HANDLING - 100 + 10) END)=a2.MES_HANDLING and a1.SIT_SITE_ID=a2.SIT_SITE_ID and a1.SHP_LG_FACILITY_ID=a2.SHP_LG_FACILITY_ID and a2.TIPO_CARGA='CPS'
LEFT JOIN STG.AMORT_SVC_LOGISTICS a3 ON  (CASE WHEN SUBSTR(CAST(a1.MES_HANDLING AS STRING), 5, 2) <> '01' THEN (a1.MES_HANDLING - 2) ELSE (a1.MES_HANDLING - 100 + 10) END)=a3.MES_HANDLING and a1.SIT_SITE_ID=a3.SIT_SITE_ID and a1.SHP_LG_FACILITY_ID=a3.SHP_LG_FACILITY_ID and a3.TIPO_CARGA='COSTO_TOTAL'
WHERE COALESCE(a2.AMORT_SVC,a3.AMORT_SVC,0) > 0
and STATUS_FACTURABLE='OK'
and PICKING_TYPE_AJUSTADO in ('XD','FBM')
and SHP_CARRIER_ID in ('Logistics','MercadoEnvios','Mercado Envios')
);


CREATE OR REPLACE TABLE STG.SHPS_TOTALES_TOTAL_LOGISTICS AS (
SELECT 
MES_HANDLING,
SIT_SITE_ID,
COUNT(shp_shipment_id) AS Q_SHP
FROM STG.CG_32
WHERE 
STATUS_FACTURABLE='OK'
and PICKING_TYPE_AJUSTADO in ('XD','FBM')
and SHP_CARRIER_ID in ('Logistics','MercadoEnvios','Mercado Envios')
GROUP BY 1,2
);



CREATE OR REPLACE TABLE STG.COSTOS_AMORT_LOGISTICS_TOTALES AS (
SELECT 
TIPO_CARGA,
MES_HANDLING,
SIT_SITE_ID,
sum(IFNULL(NUMERATOR, 0)) as SHP_LG_AMORTIZATIONS
FROM `meli-bi-data`.SBOX_SHPCDG.STG_AMORTIZATION_SVC
WHERE METRIC_NAME='SVC'
AND SHP_LG_FACILITY_ID IN ('N/A')
AND TIPO_CARGA='CPS'
group by 1,2,3

UNION ALL

SELECT 
TIPO_CARGA,
MES_HANDLING,
SIT_SITE_ID,
sum(IFNULL(NUMERATOR, 0)) as SHP_LG_AMORTIZATIONS
FROM `meli-bi-data`.SBOX_SHPCDG.STG_AMORTIZATION_SVC
WHERE METRIC_NAME='SVC'
AND SHP_LG_FACILITY_ID IN ('N/A')
AND TIPO_CARGA='COSTO_TOTAL'
group by 1,2,3

);


CREATE OR REPLACE TABLE STG.AMORT_LOGISTICS_TOTALES AS (
SELECT
A2.TIPO_CARGA,
a1.MES_HANDLING,
a1.SIT_SITE_ID,
CAST(sum(IFNULL(a2.SHP_LG_AMORTIZATIONS*1.0000, 0)) AS NUMERIC) as AMORT_LOG_TOT
FROM STG.SHPS_TOTALES_TOTAL_LOGISTICS a1 
INNER JOIN STG.COSTOS_AMORT_LOGISTICS_TOTALES a2 ON CAST(a1.MES_HANDLING AS STRING)=CAST(a2.MES_HANDLING AS STRING) and a1.SIT_SITE_ID=a2.SIT_SITE_ID AND A2.TIPO_CARGA='CPS'
GROUP BY 1,2,3

UNION ALL

SELECT
A2.TIPO_CARGA,
a1.MES_HANDLING,
a1.SIT_SITE_ID,
CAST(sum(IFNULL(a2.SHP_LG_AMORTIZATIONS*1.0000, 0))/sum(IFNULL(a1.Q_SHP*1.0000, 0)) AS NUMERIC) as AMORT_LOG_TOT
FROM STG.SHPS_TOTALES_TOTAL_LOGISTICS a1 
INNER JOIN STG.COSTOS_AMORT_LOGISTICS_TOTALES a2 ON CAST(a1.MES_HANDLING AS STRING)=CAST(a2.MES_HANDLING AS STRING) and a1.SIT_SITE_ID=a2.SIT_SITE_ID AND A2.TIPO_CARGA='COSTO_TOTAL'
GROUP BY 1,2,3
);



CREATE OR REPLACE TABLE STG.AMORT_LOGISTICS_TOTALES_SHP AS (
SELECT
a1.shp_shipment_id,
COALESCE(a2.AMORT_LOG_TOT,a3.AMORT_LOG_TOT,0) AS AMORT_LOG_TOT_2
from 
STG.CG_32 a1 
LEFT JOIN STG.AMORT_LOGISTICS_TOTALES a2 ON a1.MES_HANDLING=a2.MES_HANDLING and a1.SIT_SITE_ID=a2.SIT_SITE_ID and a2.TIPO_CARGA='CPS'
LEFT JOIN STG.AMORT_LOGISTICS_TOTALES a3 ON a1.MES_HANDLING=a3.MES_HANDLING and a1.SIT_SITE_ID=a3.SIT_SITE_ID and a3.TIPO_CARGA='COSTO_TOTAL'
WHERE COALESCE(a2.AMORT_LOG_TOT,a3.AMORT_LOG_TOT,0) > 0
and STATUS_FACTURABLE='OK'
and PICKING_TYPE_AJUSTADO in ('XD','FBM')
and SHP_CARRIER_ID in ('Logistics','MercadoEnvios','Mercado Envios')
);


CREATE OR REPLACE TABLE STG.AMORT_LOGISTICS_TOTALES_SHP_2 AS (
SELECT
a1.shp_shipment_id,
COALESCE(a2.AMORT_LOG_TOT,a3.AMORT_LOG_TOT,0) AS AMORT_LOG_TOT_2
from 
STG.CG_32 a1 
LEFT JOIN STG.AMORT_LOGISTICS_TOTALES a2 ON (CASE WHEN SUBSTR(CAST(a1.MES_HANDLING AS STRING), 5, 2) <> '01' THEN (a1.MES_HANDLING - 1) ELSE (a1.MES_HANDLING - 100 + 11) END)=a2.MES_HANDLING and a1.SIT_SITE_ID=a2.SIT_SITE_ID and a2.TIPO_CARGA='CPS'
LEFT JOIN STG.AMORT_LOGISTICS_TOTALES a3 ON (CASE WHEN SUBSTR(CAST(a1.MES_HANDLING AS STRING), 5, 2) <> '01' THEN (a1.MES_HANDLING - 1) ELSE (a1.MES_HANDLING - 100 + 11) END)=a3.MES_HANDLING and a1.SIT_SITE_ID=a3.SIT_SITE_ID and a3.TIPO_CARGA='COSTO_TOTAL'
WHERE COALESCE(a2.AMORT_LOG_TOT,a3.AMORT_LOG_TOT,0) > 0
and STATUS_FACTURABLE='OK'
and PICKING_TYPE_AJUSTADO in ('XD','FBM')
and SHP_CARRIER_ID in ('Logistics','MercadoEnvios','Mercado Envios')
);


CREATE OR REPLACE TABLE STG.AMORT_LOGISTICS_TOTALES_SHP_3 AS (
SELECT
a1.shp_shipment_id,
COALESCE(a2.AMORT_LOG_TOT,a3.AMORT_LOG_TOT,0) AS AMORT_LOG_TOT_2
from 
STG.CG_32 a1 
LEFT JOIN STG.AMORT_LOGISTICS_TOTALES a2 ON (CASE WHEN SUBSTR(CAST(a1.MES_HANDLING AS STRING), 5, 2) <> '01' THEN (a1.MES_HANDLING - 2) ELSE (a1.MES_HANDLING - 100 + 10) END)=a2.MES_HANDLING and a1.SIT_SITE_ID=a2.SIT_SITE_ID and a2.TIPO_CARGA='CPS'
LEFT JOIN STG.AMORT_LOGISTICS_TOTALES a3 ON (CASE WHEN SUBSTR(CAST(a1.MES_HANDLING AS STRING), 5, 2) <> '01' THEN (a1.MES_HANDLING - 2) ELSE (a1.MES_HANDLING - 100 + 10) END)=a3.MES_HANDLING and a1.SIT_SITE_ID=a3.SIT_SITE_ID and a3.TIPO_CARGA='COSTO_TOTAL'
WHERE COALESCE(a2.AMORT_LOG_TOT,a3.AMORT_LOG_TOT,0) > 0
and STATUS_FACTURABLE='OK'
and PICKING_TYPE_AJUSTADO in ('XD','FBM')
and SHP_CARRIER_ID in ('Logistics','MercadoEnvios','Mercado Envios')
) ;

DROP TABLE IF EXISTS STG.CG_32_BIS;

CREATE OR REPLACE TABLE STG.CG_32_BIS AS (
SELECT 
a1.*,
-- IFNULL((case 
-- when a2.AMORT_FC_2>0 then a2.AMORT_FC_2 
-- when a3.AMORT_FC_2>0 then a3.AMORT_FC_2
-- when a4.AMORT_FC_2>0 then a4.AMORT_FC_2
-- when a5.AMORT_TOT_2>0 then a5.AMORT_TOT_2 
-- when a6.AMORT_TOT_2>0 then a6.AMORT_TOT_2 
-- else a7.AMORT_TOT_2 END), 0) as SHP_AMORTIZATIONS,
IFNULL((case
when a8.AMORT_SVC_2>0 then a8.AMORT_SVC_2 
when a9.AMORT_SVC_2>0 then a9.AMORT_SVC_2 
when a10.AMORT_SVC_2>0 then a10.AMORT_SVC_2 
when a11.AMORT_LOG_TOT_2>0 then a11.AMORT_LOG_TOT_2
when a12.AMORT_LOG_TOT_2>0 then a12.AMORT_LOG_TOT_2
else a13.AMORT_LOG_TOT_2 END), 0) AS SHP_LG_AMORTIZATIONS
FROM STG.CG_32 a1 
-- left join `meli-bi-data`.SBOX_SHPCDG.AMORT_OPEX_FACILITY_SHP a2 on a1.shp_shipment_id=a2.shp_shipment_id 
-- left join `meli-bi-data`.SBOX_SHPCDG.AMORT_OPEX_FACILITY_SHP_2 a3 on a1.shp_shipment_id=a3.shp_shipment_id
-- left join `meli-bi-data`.SBOX_SHPCDG.AMORT_OPEX_FACILITY_SHP_3 a4 on a1.shp_shipment_id=a4.shp_shipment_id
-- left join `meli-bi-data`.SBOX_SHPCDG.AMORT_OPEX_TOTALES_SHP a5 on a1.shp_shipment_id=a5.shp_shipment_id 
-- left join `meli-bi-data`.SBOX_SHPCDG.AMORT_OPEX_TOTALES_SHP_2 a6 on a1.shp_shipment_id=a6.shp_shipment_id
-- left join `meli-bi-data`.SBOX_SHPCDG.AMORT_OPEX_TOTALES_SHP_3 a7 on a1.shp_shipment_id=a7.shp_shipment_id
left join STG.AMORT_SVC_LOGISTICS_SHP a8 on a1.shp_shipment_id=a8.shp_shipment_id
left join STG.AMORT_SVC_LOGISTICS_SHP_2 a9 on a1.shp_shipment_id=a9.shp_shipment_id
left join STG.AMORT_SVC_LOGISTICS_SHP_3 a10 on a1.shp_shipment_id=a10.shp_shipment_id
left join STG.AMORT_LOGISTICS_TOTALES_SHP a11 on a1.shp_shipment_id=a11.shp_shipment_id
left join STG.AMORT_LOGISTICS_TOTALES_SHP_2 a12 on a1.shp_shipment_id=a12.shp_shipment_id
left join STG.AMORT_LOGISTICS_TOTALES_SHP_3 a13 on a1.shp_shipment_id=a13.shp_shipment_id
);

